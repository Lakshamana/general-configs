# Installs minimal setup packages for artix (w/ openrc) + i3 workstation
# author: Lakshamana

#!/bin/bash

# util functions
show_usage() {
      echo 'Installs minimal setup needed packages and configs'
      echo
      echo 'usage: install [OPTIONS]'
      echo 'with OPTIONS being one of below'
      echo '--help -h: shows this help'
      echo '--verbose -v: execute verbose log commands'
      echo
}

# show help
_help_mode=`echo $@ | grep -e '-h\|--help'`
if [[ $_help_mode != '' ]]; then
      show_usage
      exit 0
fi

# allow verbose mode by running -v or --verbose
_verbose_mode=`echo $@ | grep -e '-v\|--verbose'`
log() {
      if [[  $_verbose_mode != ''  ]]; then
            echo -ne $1
            echo
      fi
}

log 'installing necessary packages...'
sudo pacman -Sy \
      maim \
      python \
      git \
      xclip \
      base-devel \
      zsh \
      curl \
      kitty \
      the_silver_searcher \
      ripgrep \
      zathura \
      zathura-pdf-mupdf \
      neovim \
      vim \
      chezmoi

# setup alacritty
cp alacritty/.alacritty.yml ~
log 'setup alacritty'

# restart i3
i3-msg restart
log 'just restarted i3...'

log 'downloading oh-my-zsh + zplug...'
# setup zsh (ohmyzsh + zplug + config)
sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
curl -sL --proto-redir -all,https https://raw.githubusercontent.com/zplug/installer/master/installer.zsh | zsh
cp zsh/.zshrc ~
log 'updated zsh conf. Will restart at the end...'

log 'downloading and installing yay...'
# install yay
cd /opt
sudo git clone https://aur.archlinux.org/yay.git
cd yay && makepkg -si
cd - # go back to previous dir

log 'updating mirrorlist...'
yay -Sy rankmirrors

rankmirrors -v -n 5 /etc/pacman.d/mirrorlist.pacnew | tee /etc/pacman.d/mirrorlist
reflector --score 5  --protocol https | tee /etc/pacman.d/mirrorlist-arch
pacman -Sc --noconfirm
pacman -Syu --noconfirm

log 'downloading asdf...'
# install asdf
yay -Sy asdf-vm

# setup asdf
asdf plugin-add nodejs

# install nodejs
asdf install nodejs $NODEJS_VERSION
asdf install nodejs lts
log 'setup nodejs asdf env'

log 'downloading vim-plug now...'
sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs \
       https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
vim -c ':source ~/.config/nvim/init.vim'
vim -c ':PlugInstall'
log 'nvim plugins successfully installed...'
